<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">

<!--     -->
<head>
<!-- GenHTML revision 23224-->
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Further Customize an Image Using Finalizer Scripts - OpenSolaris 2010.03 Distribution Constructor Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2010-03-01">
<meta name="collection" content="reference">
<link rel="stylesheet" type="text/css" href="css/elements.css">
<link rel="stylesheet" type="text/css" href="css/opensol.css">
</head>

<body>


<div class="Masthead">
   <div class="MastheadLogo">
      <a href="http://www.opensolaris.com"><img border="0" src="graphics/opensolaris_logo_trans.png"></img></a>
   </div>
   <div class="Title">OpenSolaris 2010.03 Distribution Constructor Guide</div>
</div>
<div class="headerbar"></div>


<table class="Layout" border="0" cellspacing="0" width="100%">
<tbody>

   <tr valign="top" class="PageControls">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="manifest.html">Previous</a>
             </td>
             <td align="right">
                 <a href="distro_const.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
   
   <tr valign="top">
      <td class="Navigation" width="200px"><p class="toc level1"><a href="docinfo.html">Document Information</a></p>
<p class="toc level1 tocsp"><a href="index.html">1.&nbsp;&nbsp;Introduction to the Distribution Constructor</a></p>
<p class="toc level1 tocsp"><a href="using.html">2.&nbsp;&nbsp;Design and Build OpenSolaris Images</a></p>
<p class="toc level2"><a href="sysreq.html">System Requirements</a></p>
<p class="toc level2"><a href="manifest.html">Customize Your Image by Editing the Manifests</a></p>
<div id="scrolltoc" class="onpage">
<p class="toc level2"><a href="">Further Customize an Image Using Finalizer Scripts</a></p>
</div>
<p class="toc level2"><a href="distro_const.html">Building an Image</a></p>
<p class="toc level2"><a href="trouble.html">Troubleshooting</a></p>
<p class="toc level2"><a href="addl.html">Additional Information</a></p>
<p class="toc level1 tocsp"><a href="vm.html">3.&nbsp;&nbsp;x86: Design and Build a Virtual Machine</a></p>
<p class="toc level1 tocsp"><a href="appendix.html">A.&nbsp;&nbsp;Custom Finalizer Scripts -- Examples</a></p>
</td>
      <td class="ContentPane" width="705px">

	 <div class="MainContent">      	 
             

<a name="scripts"></a><h3>Further Customize an Image Using Finalizer Scripts</h3>
<p>The distribution constructor enables you to specify scripts that can be used to
make installation customizations based on the type of image you are building. 
These scripts are called <b>finalizer scripts</b>. The manifest files point to the finalizer
scripts, and the finalizer scripts transform the generic image into a media-specific distribution.
A set of default scripts are provided in the application packages.</p><p>The distribution constructor application includes default scripts in the <tt>/usr/share/distro_const</tt> directory and subdirectories. These
scripts are referenced in the finalizer section of the manifest files.</p><p>Some of the default finalizer scripts that are used to create an
x86 Slim CD are as follows:</p><a name="scripttbl"></a><h6>Table&nbsp;2-3 x86 Slim CD Finalizer Scripts</h6><table><col width="50%"><col width="50%"><tr><th align="left" valign="top" scope="column"><p>Finalizer Script</p></th>
<th align="left" valign="top" scope="column"><p>Description</p></th>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>pre_boot_archive_pkg_image_mod</tt></p></td>
<td align="left" valign="top" scope="row"><p>Modifies image area for all types of
images</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>slim_cd/slimcd_pre_boot_archive_pkg_image_mod</tt></p></td>
<td align="left" valign="top" scope="row"><p>Modifies image area, specifically for Slim CD image</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>slim_cd/slimcd_gen_cd_content</tt></p></td>
<td align="left" valign="top" scope="row"><p>Generates the list of files
that are part of the Slim Live CD image</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>boot_archive_initialize.py</tt></p></td>
<td align="left" valign="top" scope="row"><p>Initializes the boot archive
</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>slim_cd/slimcd_boot_archive_configure</tt></p></td>
<td align="left" valign="top" scope="row"><p>Configures the boot archive, specifically for the Slim CD image</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>boot_archive_configure</tt></p></td>
<td align="left" valign="top" scope="row"><p>Configures the boot
archive </p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>boot_archive_archive.py</tt></p></td>
<td align="left" valign="top" scope="row"><p>Archives the boot archive</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>slim_cd/slimcd_post_boot_archive_pkg_image_mod</tt></p></td>
<td align="left" valign="top" scope="row"><p>Makes post-build modifications to the boot archive image
area, specifically for Slim CD image</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>grub_setup</tt></p></td>
<td align="left" valign="top" scope="row"><p>Initializes the Grub menu</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>post_boot_archive_pkg_image_mod</tt></p></td>
<td align="left" valign="top" scope="row"><p>Makes post-build modifications to the
boot archive image area</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>create_iso</tt></p></td>
<td align="left" valign="top" scope="row"><p>Creates an ISO image</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>create_usb</tt></p></td>
<td align="left" valign="top" scope="row"><p>Creates a USB image</p></td>
</tr>
</table>

<a name="customscripts"></a><h4>Creating Custom Finalizer Scripts</h4>
<p>It is recommended that you use the supplied finalizer scripts without editing them.
You do, however, have the option to write and add your own
scripts to perform additional operations as described below. If you do create new scripts,
edit the manifest files to point to these new scripts.</p>
<hr><p><b>Note - </b>Support for scripts is limited to the unmodified, default scripts that are supplied
with the application packages. If you choose to customize these scripts, back up
the original scripts first.</p>
<hr>

<ol><li><p>Plan your new scripts. Use the existing scripts as models for new scripts. Review the <a href="#characteristics">Characteristics of Finalizer Scripts</a>.</p><p>See, also, the following sample custom scripts:</p>
<ul><li><p><a href="addimage.html">Sample Script for Adding Packages to an Image</a></p></li>
<li><p><a href="testpkg.html">Sample Script for Testing Alternate Packages</a></p></li>
<li><p><a href="addpkg.html">Sample Script for Adding an SVR4 Package to an Image</a></p></li></ul>
</li>
<li><p>Create your new scripts.</p></li>
<li><p>Add your new scripts to either the <tt>/usr/local/</tt> directory, your home directory, or elsewhere on the system or network. Make sure that the root user can execute these scripts.</p></li>
<li><p>Add the new script names in the finalizer section of the appropriate manifest file. Be sure to specify the full path to your scripts in the manifest file, even if they are in the <tt>/usr/share/distro_const</tt> directory.</p></li>
<li><p>When you add a reference for a new script in the finalizer section of a manifest file, you must specify a checkpoint name that is used to pause the image build before or after this script performs its task. Optionally, you can include a custom message associated with the checkpoint name. If this message is omitted, the path of the script is used as the default checkpoint message.</p>
<hr><p><b>Note - </b>Use meaningful names for checkpoint names instead of using numbers. If new scripts are added, the new steps for those new scripts will disrupt a numbered checkpoint order.</p>
<hr>
<p>For example, the following reference in a manifest file specifies the checkpoint name of &ldquo;ba-arch&rdquo; for a boot archive archiving script, and the associated message is &ldquo;Boot archive archiving.&rdquo;</p><pre><tt>&lt;script name="/usr/share/distro_const/boot_archive_archive.py"></tt>
<tt>&lt;checkpoint name="ba-arch" message="Boot archive archiving"/></tt>
<tt>&lt;/script></tt></pre><p>This example allows you to specify a <tt>distro_const</tt> command to build your image, pausing or resuming from the &ldquo;ba-arch&rdquo; checkpoint. The build will pause just before the boot archive archiving script performs its task.</p><p>For instructions about how to refer to checkpoints in the <tt>distro_const</tt> command, see <a href="distro_const.html#checkpoint">Building an Image in Stages</a>.</p></li></ol>


<a name="characteristics"></a><h5>Characteristics of Finalizer Scripts</h5>
<p>When you create your own finalizer scripts, note the following:</p>
<ul><li><p>Scripts can be Python programs, shell scripts, or binaries.</p></li>
<li><p>Scripts are executed in the order that they are listed in the manifest file.</p></li>
<li><p>Standard output (<tt>stdout</tt>) and error output (<tt>stderr</tt>) of commands executed within finalizer scripts (both shell and python modules) are captured in the log files. <tt>stderr</tt> is captured in the simple log. Both <tt>stdout</tt> and <tt>stderr</tt> are captured in the detail log.</p></li>
<li><p>The distribution constructor passes five initial arguments to all scripts that are executed. These five arguments are not included as entries in the manifest file. The manifest file specifies additional arguments passed in after these five arguments. The initial arguments are as follows.</p></li></ul>
<h6>Table&nbsp;2-4 Finalizer Script Arguments</h6><table><col width="18%"><col width="81%"><tr><th align="left" valign="top" scope="column"><p>Argument</p></th>
<th align="left" valign="top" scope="column"><p>Description</p></th>
</tr>
<tr><td align="left" valign="top" scope="row"><p>Server socket file name</p></td>
<td align="left" valign="top" scope="row"><p>The first argument is the manifest reader socket. This
argument specifies the socket that is used with <tt>/usr/bin/ManifestRead</tt> for accessing the manifest data.
See the section about <a href="#manifestreader">Using the Manifest Reader</a>.</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p>Package image area path</p></td>
<td align="left" valign="top" scope="row"><p>The second argument is the
<tt>PKG_IMG_PATH</tt>, which specifies the path to the area where the package image is
created. Use this argument to locate a file in the package image area.
The following example checks whether the user, &ldquo;jack,&rdquo; is in the package image
area's password file.</p><pre>PKG_IMG_PATH=$2
/usr/bin/grep jack $PKG_IMG_PATH/etc/passwd >/dev/null
if [[ $? == "0" ]] ; then
   print "Found Jack"
fi </pre></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p>Temp directory</p></td>
<td align="left" valign="top" scope="row"><p>The third argument specifies a directory that is used
when creating temporary files needed during the build process.  In the following
example, you create a file in the temporary directory for building the boot
archive.</p><pre>TMP_DIR=$3
/usr/sbin/mkfile $TMP_DIR/boot_archive_archive
/usr/sbin/lofiadm -a $TMP_DIR/boot_archive_archive </pre></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p>Boot archive build area</p></td>
<td align="left" valign="top" scope="row"><p>The fourth argument is the boot archive build area,
where the boot archive files are gathered.  See the following example from
the <tt>boot_archive_configure</tt> module, which adds the file, <tt>/etc/nodename</tt>, to the boot archive. This
file gives the system the hostname, &ldquo;opensolaris.&rdquo;</p><pre>BR_BUILD=$4      # Boot archive build area

# Set nodename to opensolaris
echo "opensolaris" > $BR_BUILD/etc/nodename</pre></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p>Media area</p></td>
<td align="left" valign="top" scope="row"><p>The fifth argument specifies where
the finished media is deposited.  In the following example, the <tt>create_iso</tt> script
uses this argument to place the resultant ISO image.</p><pre>MEDIA_DIR=$5
...
DIST_ISO=${MEDIA_DIR}/${DISTRO_NAME}.iso
... </pre></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p>Additional arguments</p></td>
<td align="left" valign="top" scope="row"><p>A list of additional
arguments to be passed into a script is tagged in the manifest with
the <tt>&lt;argslist></tt> tag. The first of these arguments is  passed in as
<tt>arg6</tt>. Enclose each list item in double-quotes.  When no double-quotes are used,
or if one set of double-quotes encloses the entire string, the entire string
including spaces and newlines is interpreted as one argument.  Do not use
commas between arguments.</p><p>In the following example from the <tt>slim_cd_x86.xml</tt> manifest file, two
additional arguments are passed to the <tt>boot_archive_configure</tt> script, as <tt>arg6</tt> and <tt>arg7</tt>:</p><pre>&lt;argslist>
     "/usr/share/distro_const/slim_cd/slimcd_generic_live.xml"
     ".livecd"
&lt;/argslist></pre><p>Another
method for specifying additional arguments is to use key-value pairs. See the following
section.</p></td>
</tr>
</table>

<a name="manifestreader"></a><h5>Using the Manifest Reader</h5>
<p>The distribution constructor passes the manifest reader socket as the first argument into
finalizer scripts.  In a finalizer shell script, pass this argument as the
first argument to <tt>/usr/bin/ManifestRead</tt> for accessing the manifest data.  In a
python module, pass this argument to instantiate a ManifestRead() object.</p><p>The following Shell script example calls <tt>ManifestRead</tt> to request the <tt>name</tt> item
from the manifest file. <tt>ManifestRead</tt> returns zero or more items, each on
its own line. If <tt>ManifestRead</tt> is given multiple items to search for, the lines
returned contain both the item being searched for and a result.</p><pre>MFEST_SOCKET=$1

VOLNAME=`/usr/bin/ManifestRead ${MFEST_SOCKET} "name"`
if [ "XX${VOLNAME}" == "XX" ] ; then
       print -u2 "$0: Error retrieving volume ID"
       exit 1
fi</pre><p>The following example shows how to make use of <tt>ManifestRead</tt> from a
Python script:</p><pre>from <tt>osol_install.ManifestRead</tt> import <tt>ManifestRead</tt>

# get the manifest reader object from the socket
manifest_reader_obj = ManifestRead(MFEST_SOCKET)

# get boot_archive compression type

BR_COMPR_TYPE = get_manifest_value(manifest_reader_obj,
   "img_params/output_image/boot_archive/compression/type")
if (BR_COMPR_TYPE == None):
       raise Exception, (sys.argv[0] +
           ": boot_archive compression type missing from manifest")</pre>

<a name="keyvalue"></a><h5>Specifying Key-Value Pairs</h5>
<p>Another method for passing arguments into scripts is to specify a key-value pair.
This method is useful for passing the same argument into multiple scripts without
duplication. A script can access a keyed value by specifying the key to
<tt>/usr/bin/ManifestRead</tt> from within the script. Provide the server socket as the first argument
and then provide the node paths to the items whose values are needed,
as in the following examples.</p><h6>Example&nbsp;2-1 Shell Script</h6><p>The following example calls <tt>ManifestRead</tt> from a shell script to obtain a keyed
value.</p><pre>...
  MFEST_SOCKET=$1
  ...
  /usr/bin/ManifestRead -k $MFEST_SOCKET iso_sort
  iso_sort_file=`/usr/bin/ManifestRead $MFEST_SOCKET iso_sort`</pre><h6>Example&nbsp;2-2 Python Script</h6><p>The following example calls <tt>ManifestRead</tt> from Python to obtain the same keyed value.</p><pre>from <tt>osol_install.ManifestRead</tt> import <tt>ManifestRead</tt>

...
  IS_KEY = True

  iso_sort_file = manifest_reader_obj.get_values("iso_sort", IS_KEY)
  fd = open(iso_sort_file,....)</pre>
         </div>
      </td>
   </tr>

   <tr class="PageControls" valign="top">
      <td></td>
      <td>
         <table width="100%">
      	   <tr>
      	     <td>
                 <a href="manifest.html">Previous</a>
             </td>
             <td align="right">
                 <a href="distro_const.html">Next</a>
             </td>
           </tr>
         </table>
      </td>
   </tr>
</tbody>
</table>


</body>
</html>

